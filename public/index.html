<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="./img/SOCC.png" />
    <title>SOCC Night Walk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://kit.fontawesome.com/825a35d965.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./main.css" />

    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  </head>
  <body class="bg-black text-white">
    <div class="flex justify-between items-center p-4 measure">
      <button
        type="button"
        class="text-white aspect-square rounded-full text-center focus:outline-blue-500 focus:outline-2 focus:outline text-xl opacity-0"
      >
        <i class="bi bi-qr-code"></i>
      </button>
      <h1 class="text-2xl font-bold">SOCC Night Walk</h1>
      <button
        type="button"
        class="text-white aspect-square rounded-full text-center hover:cursor-pointer text-xl"
        data-toggle="modal"
        data-target="#scanQR"
      >
        <i class="bi bi-qr-code"></i>
      </button>
    </div>
    <div id="main" class="p-4 flex flex-col justify-between">
      <div id="table" class="w-full">
        <table class="mx-auto table-auto text-center">
          <thead>
            <tr>
              <th class="w-1/2">Station</th>
              <th class="w-1/3">Time</th>
              <th class="w-1/6 min-w-[100px]">Stamp</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>SoC</td>
              <td>1000</td>
              <td class="p-5">
                <img
                  src="./img/SOCC.png"
                  class="w-full aspect-square max-h-[100px]"
                />
              </td>
            </tr>
            <tr>
              <td>EEE</td>
              <td>1000</td>
              <td class="p-5">
                <img
                  src="./img/SOCC.png"
                  class="w-full aspect-square max-h-[100px]"
                />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="map" class="w-full h-1/2"></div>
    </div>

    <!-- scanQR -->
    <div
      class="modal hidden fixed top-0 left-0 w-full h-full outline-none fade z-[100]"
      id="scanQR"
      tabindex="-1"
      role="dialog"
    >
      <div
        class="modal-dialog relative w-auto pointer-events-none max-w-lg top-1/2 -translate-y-1/2 mx-auto px-4 sm:px-0"
        role="document"
      >
        <div
          class="relative flex flex-col mx-auto pointer-events-auto bg-zinc-900 border border-gray-600 rounded-lg"
        >
          <div
            class="flex items-start justify-end p-4 border-gray-300 rounded-t"
          >
            <button type="button" class="close" data-dismiss="modal">
              &times;
            </button>
          </div>
          <div class="relative flex px-4 flex-col pb-4 gap-2">
            <div id="video-container" class="aspect-[4/3]">
              <video id="qr-video" class="w-full h-full object-cover"></video>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      function getAbsoluteHeight(el) {
        // Get the DOM Node if you pass in a string
        el = typeof el === "string" ? document.querySelector(el) : el;

        var styles = window.getComputedStyle(el);
        var margin =
          parseFloat(styles["marginTop"]) + parseFloat(styles["marginBottom"]);

        return Math.ceil(el.offsetHeight + margin);
      }
      var heightSum = 0;
      for (var ele of document.querySelectorAll(".measure")) {
        heightSum += getAbsoluteHeight(ele);
      }
      document.getElementById("main").style.height =
        getAbsoluteHeight(document.body) - heightSum + `px`;
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-Fy6S3B9q64WdZWQUiU+q4/2Lc9npb8tCaSX9FK7E8HnRr0Jz8D6OP9dO5Vg3Q9ct"
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!--Login Check-->
    <script>
      if (localStorage.getItem("userData") == undefined) {
        window.location.href = "./login";
      }
    </script>
    <!--Map-->
    <script>
      mapboxgl.accessToken =
        "pk.eyJ1IjoidWx0cmFyYXB0b3IiLCJhIjoiY2t0cGo5aThxMGFxMzJybXBiNmZ3bWY4eSJ9.q24IUWxYYm6DhTDn5pY2Rg";
      const map = new mapboxgl.Map({
        container: "map",
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: "mapbox://styles/mapbox/dark-v11",
        zoom: 18,
      });
      map.on("load", () => {
        // map["scrollZoom"].disable();
        // map["dragPan"].disable();
        // map["dragRotate"].disable();
        // map["touchZoomRotate"].disable();
        // map["doubleClickZoom"].disable();
        // map["boxZoom"].disable();
        // var EEE_start = new mapboxgl.Marker(player, { anchor: "bottom" })
        //   .setLngLat([lng, lat])
        //   .addTo(map);
      });
      navigator.geolocation.watchPosition(
        function (position) {
          var lat = position.coords.latitude;
          var lng = position.coords.longitude;
          var heading = position.coords.heading;
          var speed = position.coords.speed; // Metre per Second
          var accuracy = position.coords.accuracy;
          // Update the map's view to center on the user's location
          map.setCenter([lng, lat]);

          // Display the user's location and direction on the map
          const player = document.createElement("div");
          player.style.backgroundImage = `url(https://media.discordapp.net/attachments/910885868733087747/1068527441720647840/image-removebg-preview.png)`;
          player.id = `playerChar`;
          player.style.minWidth = `10px`;
          player.style.maxWidth = `50px`;
          player.style.width = `10vw`;
          player.style.aspectRatio = `1`;
          player.style.backgroundSize = `100%`;
          player.style.zIndex = `99`;
          if (document.querySelectorAll("#playerChar").length >= 1) {
            document.querySelectorAll("#playerChar")[0].remove();
          }
          var marker = new mapboxgl.Marker(player, { anchor: "bottom" })
            .setLngLat([lng, lat])
            .addTo(map);
          marker.setRotation(heading);
          map.setBearing(heading);
        },
        (err) => {
          console.error(`ERROR(${err.code}): ${err.message}`);
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0,
        }
      );
    </script>
    <!--QR Reader-->
    <script type="module">
      import QrScanner from "./js/qr-scanner.min.js";

      const video = document.getElementById("qr-video");
      const videoContainer = document.getElementById("video-container");

      function setResult(result) {
        console.log(result.data);
        alert(result.data);
        $("#scanQR").modal("hide");
      }

      // ####### Web Cam Scanning #######

      const scanner = new QrScanner(video, (result) => setResult(result), {
        highlightScanRegion: true,
        highlightCodeOutline: true,
      });

      window.scanner = scanner;

      $("#scanQR").on("shown.bs.modal", function (e) {
        scanner.start();
      });
    </script>
    <!--Client Side Script-->
    <script>
      if (localStorage.getItem("colorDict") == undefined) {
        var colorArr = [
          "R",
          "B",
          "G",
          "Y",
          "R",
          "B",
          "G",
          "Y",
          "R",
          "B",
          "G",
          "Y",
          "R",
          "B",
          "G",
          "Y",
          "R",
          "B",
          "G",
          "Y",
          "R",
          "B",
          "G",
          "Y",
          "R",
          "B",
          "G",
          "Y",
          "W",
          "W",
        ];
        var urlArr = [
          "abd37534c7d9a2efb9465de931cd7055ffdb8879563ae98078d6d6d5",
          "c681e18b81edaf2b66dd22376734dba5992e362bc3f91ab225854c17",
          "1053463d383dc1e87f06fff34b3c6a2d340d91e184d46d70144ffa5a",
          "06c9f71496e24dec6acc44895648cf9ec40b5cebb7bc4858a3c69f25",
          "d5070e2f67ededca022f81f2941900606b16f3196b2268e856295f59",
          "d4bf0e3ad56b3494897f5f0a1ce7b300e7dc8d838d1a384ce121bf7a",
          "61246db30c51c3fe46779bcfc01eb6b3d2dee9d77d6837024134d8a9",
          "e0ccaeadfef916630c35576679e4cd4b438e7fc95a60b7361705f708",
          "9d4e0997db72e9c1d02a39b8fb969f508a0f65e5303118de9e037a02",
          "fcd074cdd4c6e02b5dbe28f33858f8ed6d3e9e5ca5ff873f07371f3f",
          "5006bab5782456808d60bddfa64db2d13d90b2c5550ba1ff2b2acad7",
          "2e0cc996fafd71bfabc0717628bd3296306b078910b68f081f3d3fcc",
          "4fde0463771d8c4fb82794d5d6d003725c819dd34360e7bf9c70cffe",
          "73363bb5e0e56db01ad3853166fa945628d165930473b5ee5608edeb",
          "cbb625b441474e8dd944e43632d9112c7e4213cce5410b5b3ce59f56",
          "e22bd066f428b7a77a1b936f99c1f4c117b856705d8f90379579f1e9",
          "8acd70840f1928a2a80c548d7599a07e752a6804612469d1dabac68a",
          "90ffc2300bfbe8fbdddb57bc85db44fd0217b079b14e729e9ac98227",
          "0dd8c67786f88335c6caf127b82032f47633948703d7f3dfd9d61fc0",
          "991a908ad5fc70a65e7d36714f4d2088809a8842c89d56dd421fcb45",
          "df4e71601e2a93f5d17e9599f25acd249f3fb20cf57ed8e1d56aba76",
          "5e4165a6124f2afc058d013b360ff4444fe16e69048092a4f635caea",
          "54a2f7f92a5f975d8096af77a126edda7da60c5aa872ef1b871701ae",
          "518d3dd9f8f74ecc34ed7d6ce4310b5fbab8f222b1006ffaf6ea0c43",
          "2c89060719a95c7cb741f04e36835430436840e3052273676c6c1a99",
          "5cfe2cddbb9940fb4d8505e25ea77e763a0077693dbb01b1a6aa94f2",
          "d14a028c2a3a2bc9476102bb288234c415a2b01f828ea62ac5b3e42f",
          "484d52691fcadbfabec5a318d1cf9692c7f293cbc8c1d5f22b2d839b",
          "7497e88b8c64062edfb2f30b9c5f845552b841d1fbae97ab3f224f74",
          "5b1cfa35e55802f5bcd92750b9f1441d63ddeabba543f9f7d87d8fb3",
        ];
        shuffleArr(colorArr);
        shuffleArr(urlArr);
        var colorDict = {};
        for (var index in urlArr) {
          colorDict[urlArr[index]] = colorArr[index];
        }
        axios
          .post("./update", {
            links: colorDict,
            userID: JSON.parse(localStorage.getItem("userData")).id,
          })
          .then((response) => {
            localStorage.setItem("colorDict", JSON.stringify(colorDict));
            localStorage.setItem("userData", JSON.stringify(response.data[0]));
          })
          .catch((error) => {
            console.log(error);
          });
      }
      function shuffleArr(array) {
        let currentIndex = array.length,
          randomIndex;

        // While there remain elements to shuffle.
        while (currentIndex != 0) {
          // Pick a remaining element.
          randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;

          // And swap it with the current element.
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex],
            array[currentIndex],
          ];
        }

        return array;
      }
    </script>
  </body>
</html>
